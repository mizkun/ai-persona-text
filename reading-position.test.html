<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª­æ›¸ä½ç½®è¨˜éŒ²æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        .test-case {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .test-case h3 {
            margin-top: 0;
        }
        .pass {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        .fail {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        .pending {
            background-color: #fff3cd;
            border-color: #ffeaa7;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 0.5rem;
        }
        button:hover {
            background: #0056b3;
        }
        .error {
            color: #721c24;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>èª­æ›¸ä½ç½®è¨˜éŒ²æ©Ÿèƒ½ - TDDãƒ†ã‚¹ãƒˆ</h1>
    <p>ã“ã®ãƒ†ã‚¹ãƒˆã¯å®Ÿè£…å‰ã«ä½œæˆã•ã‚Œã¦ã„ã¾ã™ã€‚ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹ã¯ãšã§ã™ã€‚</p>

    <button onclick="runAllTests()">ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ</button>
    <button onclick="clearLocalStorage()">LocalStorageã‚’ã‚¯ãƒªã‚¢</button>

    <div id="test-results"></div>

    <script>
        // Import functions from text.html (copy the implementation here for testing)
        const READING_POSITION_KEY = 'persona-text-reading-position';

        // Save reading position to localStorage
        function saveReadingPosition(pageIndex) {
            try {
                localStorage.setItem(READING_POSITION_KEY, JSON.stringify(pageIndex));
            } catch (e) {
                console.error('Error saving reading position:', e);
            }
        }

        // Load reading position from localStorage
        function loadReadingPosition() {
            try {
                const stored = localStorage.getItem(READING_POSITION_KEY);
                return stored ? JSON.parse(stored) : 0;
            } catch (e) {
                console.error('Error loading reading position:', e);
                return 0;
            }
        }

        // Mock function for integration test
        function initReadingProgress() {
            // This is a mock for testing purposes
            return true;
        }

        // ãƒ†ã‚¹ãƒˆçµæœã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function displayTestResult(testName, passed, message) {
            const resultsDiv = document.getElementById('test-results');
            const testDiv = document.createElement('div');
            testDiv.className = `test-case ${passed ? 'pass' : 'fail'}`;
            testDiv.innerHTML = `
                <h3>${passed ? 'âœ“' : 'âœ—'} ${testName}</h3>
                <p>${message}</p>
            `;
            resultsDiv.appendChild(testDiv);
        }

        // ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        function runAllTests() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '';

            test_saveReadingPosition_shouldSaveToLocalStorage();
            test_loadReadingPosition_shouldReturnSavedPosition();
            test_loadReadingPosition_shouldReturnZeroWhenNoSavedPosition();
            test_saveReadingPosition_shouldUpdateExistingPosition();
            test_loadReadingPosition_shouldReturnNumberType();
            test_initReadingProgress_shouldRestoreLastPosition();
        }

        // LocalStorageã‚’ã‚¯ãƒªã‚¢
        function clearLocalStorage() {
            localStorage.removeItem(READING_POSITION_KEY);
            alert('LocalStorageã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        }

        // ãƒ†ã‚¹ãƒˆ1: saveReadingPositioné–¢æ•°ãŒlocalStorageã«ä¿å­˜ã™ã‚‹ã“ã¨
        function test_saveReadingPosition_shouldSaveToLocalStorage() {
            const testName = 'saveReadingPosition: localStorageã«ä½ç½®ã‚’ä¿å­˜ã™ã‚‹';

            try {
                // äº‹å‰æº–å‚™: localStorageã‚’ã‚¯ãƒªã‚¢
                localStorage.removeItem(READING_POSITION_KEY);

                // å®Ÿè¡Œ: ãƒšãƒ¼ã‚¸5ã‚’ä¿å­˜
                if (typeof saveReadingPosition === 'undefined') {
                    throw new Error('saveReadingPositioné–¢æ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                saveReadingPosition(5);

                // æ¤œè¨¼: localStorageã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹
                const saved = localStorage.getItem(READING_POSITION_KEY);
                if (saved === null) {
                    throw new Error('localStorageã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }

                const position = JSON.parse(saved);
                if (position !== 5) {
                    throw new Error(`æœŸå¾…å€¤: 5, å®Ÿéš›ã®å€¤: ${position}`);
                }

                displayTestResult(testName, true, 'ãƒšãƒ¼ã‚¸ä½ç½®5ãŒlocalStorageã«æ­£ã—ãä¿å­˜ã•ã‚Œã¾ã—ãŸ');
            } catch (error) {
                displayTestResult(testName, false, `ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // ãƒ†ã‚¹ãƒˆ2: loadReadingPositioné–¢æ•°ãŒä¿å­˜ã•ã‚ŒãŸä½ç½®ã‚’è¿”ã™ã“ã¨
        function test_loadReadingPosition_shouldReturnSavedPosition() {
            const testName = 'loadReadingPosition: ä¿å­˜ã•ã‚ŒãŸä½ç½®ã‚’è¿”ã™';

            try {
                // äº‹å‰æº–å‚™: ä½ç½®10ã‚’ä¿å­˜
                localStorage.setItem(READING_POSITION_KEY, JSON.stringify(10));

                // å®Ÿè¡Œ
                if (typeof loadReadingPosition === 'undefined') {
                    throw new Error('loadReadingPositioné–¢æ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                const position = loadReadingPosition();

                // æ¤œè¨¼
                if (position !== 10) {
                    throw new Error(`æœŸå¾…å€¤: 10, å®Ÿéš›ã®å€¤: ${position}`);
                }

                displayTestResult(testName, true, 'ä¿å­˜ã•ã‚ŒãŸä½ç½®10ãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');
            } catch (error) {
                displayTestResult(testName, false, `ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // ãƒ†ã‚¹ãƒˆ3: loadReadingPositioné–¢æ•°ãŒä¿å­˜ãŒãªã„å ´åˆ0ã‚’è¿”ã™ã“ã¨
        function test_loadReadingPosition_shouldReturnZeroWhenNoSavedPosition() {
            const testName = 'loadReadingPosition: ä¿å­˜ãŒãªã„å ´åˆã¯0ã‚’è¿”ã™';

            try {
                // äº‹å‰æº–å‚™: localStorageã‚’ã‚¯ãƒªã‚¢
                localStorage.removeItem(READING_POSITION_KEY);

                // å®Ÿè¡Œ
                if (typeof loadReadingPosition === 'undefined') {
                    throw new Error('loadReadingPositioné–¢æ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                const position = loadReadingPosition();

                // æ¤œè¨¼
                if (position !== 0) {
                    throw new Error(`æœŸå¾…å€¤: 0, å®Ÿéš›ã®å€¤: ${position}`);
                }

                displayTestResult(testName, true, 'ä¿å­˜ãŒãªã„å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤0ãŒè¿”ã•ã‚Œã¾ã—ãŸ');
            } catch (error) {
                displayTestResult(testName, false, `ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // ãƒ†ã‚¹ãƒˆ4: saveReadingPositioné–¢æ•°ãŒæ—¢å­˜ã®ä½ç½®ã‚’ä¸Šæ›¸ãã™ã‚‹ã“ã¨
        function test_saveReadingPosition_shouldUpdateExistingPosition() {
            const testName = 'saveReadingPosition: æ—¢å­˜ã®ä½ç½®ã‚’ä¸Šæ›¸ãã™ã‚‹';

            try {
                // äº‹å‰æº–å‚™: ä½ç½®3ã‚’ä¿å­˜
                localStorage.setItem(READING_POSITION_KEY, JSON.stringify(3));

                // å®Ÿè¡Œ: ä½ç½®7ã§ä¸Šæ›¸ã
                if (typeof saveReadingPosition === 'undefined') {
                    throw new Error('saveReadingPositioné–¢æ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                saveReadingPosition(7);

                // æ¤œè¨¼
                const saved = localStorage.getItem(READING_POSITION_KEY);
                const position = JSON.parse(saved);
                if (position !== 7) {
                    throw new Error(`æœŸå¾…å€¤: 7, å®Ÿéš›ã®å€¤: ${position}`);
                }

                displayTestResult(testName, true, 'æ—¢å­˜ã®ä½ç½®ãŒ7ã«ä¸Šæ›¸ãã•ã‚Œã¾ã—ãŸ');
            } catch (error) {
                displayTestResult(testName, false, `ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // ãƒ†ã‚¹ãƒˆ5: loadReadingPositioné–¢æ•°ãŒæ•°å€¤å‹ã‚’è¿”ã™ã“ã¨
        function test_loadReadingPosition_shouldReturnNumberType() {
            const testName = 'loadReadingPosition: æ•°å€¤å‹ã‚’è¿”ã™';

            try {
                // äº‹å‰æº–å‚™
                localStorage.setItem(READING_POSITION_KEY, JSON.stringify(15));

                // å®Ÿè¡Œ
                if (typeof loadReadingPosition === 'undefined') {
                    throw new Error('loadReadingPositioné–¢æ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                const position = loadReadingPosition();

                // æ¤œè¨¼
                if (typeof position !== 'number') {
                    throw new Error(`æœŸå¾…ã•ã‚Œã‚‹å‹: number, å®Ÿéš›ã®å‹: ${typeof position}`);
                }

                displayTestResult(testName, true, 'æ•°å€¤å‹ãŒæ­£ã—ãè¿”ã•ã‚Œã¾ã—ãŸ');
            } catch (error) {
                displayTestResult(testName, false, `ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // ãƒ†ã‚¹ãƒˆ6: initReadingProgressé–¢æ•°ãŒãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«æœ€å¾Œã®ä½ç½®ã‚’å¾©å…ƒã™ã‚‹ã“ã¨
        function test_initReadingProgress_shouldRestoreLastPosition() {
            const testName = 'initReadingProgress: ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«æœ€å¾Œã®ä½ç½®ã‚’å¾©å…ƒã™ã‚‹ï¼ˆçµ±åˆãƒ†ã‚¹ãƒˆï¼‰';

            try {
                // äº‹å‰æº–å‚™: ä½ç½®12ã‚’ä¿å­˜
                localStorage.setItem(READING_POSITION_KEY, JSON.stringify(12));

                // æ³¨æ„: ã“ã®çµ±åˆãƒ†ã‚¹ãƒˆã¯å®Ÿéš›ã®ãƒšãƒ¼ã‚¸ã§å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
                // ã“ã“ã§ã¯é–¢æ•°ã®å­˜åœ¨ã®ã¿ã‚’ç¢ºèª
                if (typeof initReadingProgress === 'undefined') {
                    throw new Error('initReadingProgressé–¢æ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }

                // ã“ã®çµ±åˆãƒ†ã‚¹ãƒˆã¯å®Ÿéš›ã®text.htmlãƒšãƒ¼ã‚¸ã§æ‰‹å‹•æ¤œè¨¼ãŒå¿…è¦
                displayTestResult(testName, false, 'çµ±åˆãƒ†ã‚¹ãƒˆã¯å®Ÿéš›ã®ãƒšãƒ¼ã‚¸ã§æ‰‹å‹•æ¤œè¨¼ãŒå¿…è¦ã§ã™ï¼ˆç¾åœ¨ã¯æœªå®Ÿè£…ï¼‰');
            } catch (error) {
                displayTestResult(testName, false, `ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®èª¬æ˜ã‚’è¡¨ç¤º
        window.addEventListener('DOMContentLoaded', function() {
            const resultsDiv = document.getElementById('test-results');
            const infoDiv = document.createElement('div');
            infoDiv.className = 'test-case pending';
            infoDiv.innerHTML = `
                <h3>ğŸ“ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ–¹æ³•</h3>
                <p>1. ã€Œã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</p>
                <p>2. ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼ˆå®Ÿè£…å‰ã®ãŸã‚ï¼‰</p>
                <p>3. å®Ÿè£…å¾Œã«å†åº¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã€ã™ã¹ã¦ãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„</p>
            `;
            resultsDiv.appendChild(infoDiv);
        });
    </script>
</body>
</html>
